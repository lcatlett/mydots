#!/bin/bash
# usage e.g. siteme <domain.com> siteme <sitename> siteme <url> siteme <site_id>
# A simple script to fetch the pantheon admin site dashboard
# Carey Dayrit - 01/Jul/2021
# Thanks to Albert Causing
# Requirements ggrep
# brew install grep
# Use it at your own risk

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

if [ -z "$1" ]; then
    echo "Usage siteme ufc.com / siteme ufc / siteme 7a1e4432-7c89-422e-9a69-eeb139ad83a1"
    exit
fi

# Fetch the username on ~/.ssh/config
PANTH_USERNAME="`ssh -G REDACTED-INTERNAL-HOST | grep 'user ' | awk -F' ' '{ print $2 }' | xargs`"

# strip http and https
SITE="`echo $1 | sed -e 's/^http:\/\///g' -e 's/^https:\/\///g'`"

# remove characters after /
SITE="`cut -f1 -d"/" <<< $SITE`"

UNAME=$(uname)

if [[ "$UNAME" == "Linux" ]]; then
	FQDN="`echo $SITE | grep -P '(?=^.{1,254}$)(^(?>(?!\d+\.)[a-zA-Z0-9_\-]{1,63}\.?)+(?:[a-zA-Z]{2,})$)'`"
	else
	if ! [ -x "$(command -v ggrep)" ]; then
		echo 'Error: The ggrep command was not found. Please install it yourself and try again. https://formulae.brew.sh/formula/grep' >&2
		exit 1
	fi
	FQDN="`echo $SITE | ggrep -P '(?=^.{1,254}$)(^(?>(?!\d+\.)[a-zA-Z0-9_\-]{1,63}\.?)+(?:[a-zA-Z]{2,})$)'`"
fi


# conditional if the input is an FQDN or a sitename
if [[ -n $FQDN ]]; then
	# domain url
    ssh $PANTH_USERNAME@`dig +short REDACTED-INTERNAL-HOST | tail -1` "/usr/local/bin/pantheon sites:$1" >&1| tail -n 3 | head -n 1
else
   if [[ ${#SITE} -eq 36 ]];then
    # site_id
	CHECKSITE_ID=$(echo $1 | grep '^[a-zA-Z0-9]\{8\}[ -][a-zA-Z0-9]\{4\}[ -][a-zA-Z0-9]\{4\}[ -][a-zA-Z0-9]\{4\}[ -][a-zA-Z0-9]\{12\}$')
	if [ -z ${CHECKSITE_ID} ]; then
		echo "Site ID invalid"
		exit 1
	fi
	ssh $PANTH_USERNAME@`dig +short REDACTED-INTERNAL-HOST | tail -1` "/usr/local/bin/pantheon sites:$1" >&1| tail -n 3 | head -n 1
   else
    #site_name
    ssh $PANTH_USERNAME@`dig +short REDACTED-INTERNAL-HOST | tail -1` "/usr/local/bin/pantheon sites:dev-$1.pantheonsite.io" >&1| tail -n 3 | head -n 1
   fi
fi